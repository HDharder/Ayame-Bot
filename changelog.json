{
  "updates": [
    {
      "version": "1.4.2",
      "date": "2025-11-03",
      "title": "Hotfix /exibir: Leitura de Logs em Fóruns",
      "features": [],
      "fixes": [
        "Corrigido o comando `/exibir opcao: Histórico de Gastos` que não encontrava as mensagens de log quando usado em um canal de fórum (Inventário).",
        "O comando agora procura os logs no canal atual (`interaction.channel`), em vez de procurar no canal de log global (`LOG_CHANNEL_ID`)."
      ],
      "backend": []
    },
    {
      "version": "1.4.1",
      "date": "2025-11-03",
      "title": "Correção do /gasto: Logs no Canal Correto",
      "features": [],
      "fixes": [
        "Corrigido o comando `/gasto` que enviava a mensagem de log para o canal de log global em vez do canal de inventário do jogador."
      ],
      "backend": []
    },
    {
      "version": "1.4.0",
      "date": "2025-11-03",
      "title": "Novos Comandos de Inventário: /gasto e /exibir",
      "features": [
        "**Novo Comando `/gasto`:** Permite que jogadores registem gastos de Ouro ou Itens.",
        "O `/gasto` só pode ser usado no canal de inventário registado do jogador.",
        "O comando envia um log detalhado para o canal de inventário e salva o ID da mensagem de log na coluna 'Gastos' da planilha do jogador.",
        "**Novo Comando `/exibir`:** Permite que jogadores consultem históricos relacionados ao seu personagem.",
        "**`/exibir opcao: Histórico de Gastos`:** Busca todos os IDs de log da coluna 'Gastos', formata-os num Embed paginado e exibe ao jogador, incluindo data, hora, ouro, itens e motivo.",
        "**`/exibir opcao: Histórico de Mesas Jogadas`:** Busca no 'Controle de Mesas' todas as mesas finalizadas ('Sim') que o personagem jogou.",
        "O histórico de mesas exibe o Mestre, Tier, e o loot final (processando corretamente o 'Dobro Ativado' e itens de 'Gold Extra')."
      ],
      "fixes": [],
      "backend": [
        "**Nova Função `batchRemoveInventories`:** Criada em `inventoryManager.js` para remover Ouro e Itens em lote, atualizando a planilha e os embeds do Discord.",
        "**Novo Utilitário `exibirUtils.js`:** Criado para modularizar a lógica de busca e processamento do histórico de mesas jogadas."
      ]
    },
    {
      "version": "1.3.7",
      "date": "2025-11-02",
      "title": "/loot: Correção na Agregação de Itens Pré-definidos",
      "features": [],
      "fixes": [
        "Corrigido um bug crítico no `/loot` onde itens normais e itens pré-definidos (`*`) com o mesmo nome (ex: 'Poção de Cura' e 'Poção de Cura*') eram incorretamente agrupados como um único item."
      ],
      "backend": [
        "O sistema de parse e agregação de itens foi refatorado para usar uma chave composta (`nome|isPredefined`) em vez de apenas `item.name`.",
        "Atualizadas as funções `parseItemInput`, `getAvailableDrops`, `formatPlayerList`, `finalizar_loot` e `updateHistoricoSheet` para usar a nova lógica de chave composta.",
        "Atualizados os menus de seleção (simples e paginado) para incluir a flag `isPredefined` no `value` do item, permitindo a diferenciação."
      ]
    },
    {
      "version": "1.3.5",
      "date": "2025-11-01",
      "title": "Melhorias no /loot: Gold Extra como Item",
      "features": [
        "**Gold Extra no `/loot`:** Adicionado o parâmetro opcional `gold_extra: True` ao `/loot`, que habilita um botão 'Adicionar Gold Extra'.",
        "O mestre pode agora adicionar 'itens de gold' (ex: `100 PO`, `2x 50`, `150 PO*`) como drops no loot.",
        "O parser de 'Gold Extra' foi atualizado para aceitar valores com ou sem `PO` (ex: `100` ou `100 PO`), mas sempre formata a saída como `XX.XX PO`.",
        "Itens de 'Gold Extra' agora podem ser marcados com `*` para serem dobrados pelo 'Double Gold' (ex: `2x 100 PO*`)."
      ],
      "fixes": [
        "Corrigido o `handleEncerrarMesaClick` no `lootUtils.js` para processar corretamente os 'itens de gold' pegos pelos jogadores, somando-os ao gold total do inventário em vez de adicioná-los como itens."
      ],
      "backend": [
        "O `handleModal` do `loot.js` agora tem uma Regex específica para lidar com a entrada de 'Gold Extra'."
      ]
    },
    {
      "version": "1.3.4",
      "date": "2025-11-01",
      "title": "Melhorias no /loot: Itens Pré-definidos e Correções de Lógica",
      "features": [
        "Adicionada a opção `drop_de_misc` ao comando `/loot`.",
        "O parâmetro `loot_previsto` foi renomeado para `nao_rolar_loot_com_vantagem` para maior clareza.",
        "**Itens Pré-definidos (`*`):** Itens inseridos no `/loot` com um `*` no final (ex: `Poção de Cura*`) agora são dobrados (quantidade x2) para jogadores que ativarem o \"Double Gold\"."
      ],
      "fixes": [
        "Corrigida a contagem de mesa extra do \"Double Gold\" (`/loot`), que estava a ser adicionada na semana *atual* em vez da semana *anterior*."
      ],
      "backend": [
        "O parser de itens (`parseItemInput`) agora reconhece e remove o `*` do nome do item, guardando-o como um booleano (`isPredefined`).",
        "`utils/playerLootUtils.js` foi atualizado para guardar o objeto de item completo (incluindo `isPredefined`) na seleção do jogador.",
        "`utils/lootUtils.js` foi atualizado para mostrar o `*` nos logs (`formatPlayerList`) e no menu de seleção (`formatDropsList`)."
      ]
    },
    {
      "version": "1.3.3",
      "date": "2025-10-31",
      "title": "Revisão do /relatorio & Melhorias de Inventário",
      "features": [
        "**`/relatorio` agora atualiza o inventário:** O comando `/relatorio` agora atualiza o inventário dos jogadores (gold e itens) ao finalizar, tal como o `/loot`.",
        "**Gold Opcional no `/relatorio`:** O parâmetro `gold_total` agora é opcional. Se deixado em branco, o bot rolará o gold automaticamente (usando a lógica do `/loot`).",
        "**Gold Extra no `/relatorio`:** Adicionado um botão 'Gold Extra' na interface de drops para adicionar bônus de gold individualmente por jogador.",
        "**Drops 'Misc' no `/relatorio`:** Adicionada a opção e o botão `drop_misc` para itens que não precisam de validação."
      ],
      "fixes": [
        "**Categorização de Itens:** Corrigido o sistema de atualização de inventário (`/loot` e `/relatorio`) para salvar itens nas colunas corretas (ex: a aba 'Poções' agora salva em 'Consumíveis Mágicos', e a aba 'Itens' salva em 'Itens Mágicos').",
        "**Categorização de Mundanos:** 'Itens Mundanos' agora são classificados corretamente como 'Armas' ou 'Escudos/Armaduras' no inventário, com base na coluna 'Type' da Tabela de Craft."
      ],
      "backend": [
        "O parser de itens (`parseItemInput`) agora suporta a sintaxe de colchetes (ex: `Arma +1 [Espada Longa]`), salvando o nome completo mas usando o nome base (`Arma +1`) para validação e categorização."
      ]
    },
    {
      "version": "1.3.2",
      "date": "2025-10-31",
      "title": "Comando de Ajuda & Sistema de Autocomplete",
      "features": [
        "**Novo Comando `/help`:** Adicionado comando `/help` para listar todos os comandos ou mostrar detalhes sobre um comando específico (uso, permissões)."
      ],
      "fixes": [],
      "backend": [
        "Adicionado suporte para interações `isAutocomplete()` ao `index.js` (roteador de interações).",
        "O comando `/help` usa o novo sistema de autocomplete para sugerir nomes de comandos.",
        "Criado o ficheiro `help.json` para armazenar dinamicamente os textos de ajuda do bot."
      ]
    },
    {
      "version": "1.3.1",
      "date": "2025-10-29",
      "title": "Otimização de Atualização de Inventário",
      "features": [],
      "fixes": [
        "**Otimização Crítica:** Refatorado o processo de atualização de inventários (ao usar 'Encerrar Mesa') para usar operações em lote (`batchUpdateInventories`), resolvendo erros de quota da API do Google (`[429] Quota exceeded`).",
        "Corrigido erro `ReferenceError: rowChanged is not defined` que ocorria durante a atualização em lote de inventários.",
        "Corrigido erro na função `getItemCategory` que impedia o retorno correto de categorias de itens já presentes no cache."
      ],
      "backend": [
        "Implementada função `preloadInventoryEmbedData` para carregar dados de Tokens, Níveis e XP de forma otimizada antes de atualizar múltiplos inventários.",
        "Implementada função `preloadItemCategories` para carregar todas as categorias de itens em cache de uma só vez.",
        "Adicionado um atraso (`delay`) entre as operações de escrita (`row.save()`) na atualização em lote para mitigar limites de escrita da API."
      ]
    },
    {
      "version": "1.3.0",
      "date": "2025-10-28",
      "title": "Comando /inventario & Funções Genéricas Google",
      "features": [
        "**Novo Comando `/inventario`:** Permite aos jogadores exibir o inventário dos seus personagens num canal dedicado.",
        "O comando `/inventario` regista o canal para o personagem selecionado, impedindo que outros jogadores usem o mesmo canal.",
        "O comando `/inventario` atualiza automaticamente o canal registado e apaga mensagens antigas se o jogador trocar de personagem ou re-executar o comando.",
        "O comando `/inventario` calcula e exibe `Nível / Qtd. Mesas no Nível` buscando dados das abas 'Inventário', 'Primários'/'Secundários' e 'Player ID'.",
        "O comando `/inventario` exibe Gold (GP/PP/PC), Tokens e itens divididos por categoria (Mundanos, Armas, Armaduras, etc.).",
        "**Restrição de Canal:** Implementado `utils/channelGuard.js` que lê regras da aba 'Player ID' para restringir onde comandos (como `/inventario`) podem ser usados (Texto, Fórum, Categoria)."
      ],
      "fixes": [
        "Corrigidos múltiplos erros no comando `/inventario` relacionados a timeouts (`Unknown interaction`), valores duplicados no seletor (`SELECT_COMPONENT_OPTION_VALUE_DUPLICATED`), e falhas ao carregar/salvar células na planilha (`rowIndex undefined`, `Cell not loaded`, `Unable to parse range`).",
        "Corrigido erro no cálculo de `Nível / Qtd. Mesas` que lia a coluna errada ('Total' em vez de 'Mesas Jogadas') na aba 'Primários'/'Secundários'."
      ],
      "backend": [
        "**Funções Genéricas Google:** Adicionadas `getValueFromSheet`, `setValueInSheet`, `clearValueInSheet` em `utils/google.js` para buscar e alterar células individuais de forma segura (preservando fórmulas), usando o método de iteração de células.",
        "A função `registerChannel` em `utils/inventarioUtils.js` foi refatorada para usar as novas funções genéricas."
      ]
    },
    {
      "version": "1.2.0",
      "date": "2025-10-28",
      "title": "Drops Mundanos & Contagem de Mesas",
      "features": [
        "Adicionada a opção 'drop_de_mundanos' ao comando `/loot`.",
        "Adicionada validação para a aba 'Itens Mundanos' na Tabela de Craft.",
        "Mestres agora recebem +1 em 'Mesas Mestradas' (planilha 'Tokens') ao usar o botão 'Encerrar Mesa'."
      ],
      "fixes": [
        "Um bug na hora de definir os tokens gastos alterava a linha inteira do jogador escolhido, perdendo todas as fómulas que tinham. Isso foi corrigido para alterar apenas a célula designada ('Double Up')."
      ],
      "backend": []
    },
    {
      "version": "1.1.0",
      "date": "2025-10-27",
      "title": "Refatoração de Permissões e Custo do Dobro",
      "features": [
        "Criado o módulo `utils/auth.js` para centralizar todas as verificações de permissão (Narrador/Staff/Mestre).",
        "Todos os comandos (`/loot`, `/relatorio`, `/abrir-mesa`, etc.) foram atualizados para usar o novo `auth.js`.",
        "A função `spendPlayerTokens` agora incrementa a coluna 'Double Up' em +1, em vez de subtrair 4 tokens."
      ],
      "fixes": [],
      "backend": []
    },
    {
      "version": "1.0.0",
      "date": "2025-10-24",
      "title": "Lançamento Inicial",
      "features": [
        "Sistema de Loot (`/loot`)",
        "Sistema de Registro de Mesa (`/abrir-mesa`, `/registrar-mesa`)",
        "Sistema de Sorteio (`/sortear`)"
      ],
      "fixes": [],
      "backend": []
    }
  ]
}